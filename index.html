<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cuaderno del Profesor (Local)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        /* Evitar que el número en input[type=number] tenga flechas */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] { -moz-appearance: textfield; }
        
        /* Estilos de impresión */
        @media print {
            body {
                font-size: 10px; /* Reduce el tamaño de la fuente base para imprimir */
            }
            body * {
                visibility: hidden;
            }
            #printable-schedule, #printable-schedule * {
                visibility: visible;
            }
            #printable-schedule {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
            }
            #printable-schedule table {
                width: 100%;
                table-layout: fixed; /* Clave para controlar el ancho de las columnas */
                font-size: 9px; /* Fuente más pequeña dentro de la tabla */
                border-spacing: 0;
            }
            #printable-schedule th, #printable-schedule td {
                padding: 4px 2px; /* Reduce el padding */
                word-wrap: break-word; /* Rompe palabras largas si es necesario */
            }
             #printable-schedule button, #printable-schedule div[style*="background-color"] {
                font-size: 8px !important; /* Fuente aún más pequeña en los botones */
                padding: 2px !important;
                min-height: 0 !important;
                white-space: normal !important;
                line-height: 1.2 !important;
                height: 100% !important;
            }
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex h-screen">
        <!-- Sidebar de Navegación -->
        <nav class="flex flex-col justify-between w-16 sm:w-56 bg-white border-r border-gray-200 p-3 no-print">
            <div>
                <div class="flex items-center gap-3 mb-8 px-2">
                    <div data-lucide="book-user" class="text-blue-600 w-7 h-7"></div>
                    <h1 class="text-xl font-bold text-gray-800 hidden sm:inline">Cuaderno del Profesor</h1>
                </div>
                <div class="space-y-2">
                    <button data-view="schedule" class="nav-button flex flex-col sm:flex-row items-center justify-center sm:justify-start gap-2 w-full p-3 text-sm font-medium rounded-md transition-colors bg-blue-600 text-white">
                        <div data-lucide="calendar-days" class="w-5 h-5"></div>
                        <span class="hidden sm:inline">Horario</span>
                    </button>
                    <button data-view="classes" class="nav-button flex flex-col sm:flex-row items-center justify-center sm:justify-start gap-2 w-full p-3 text-sm font-medium rounded-md transition-colors text-gray-600 hover:bg-gray-200 hover:text-gray-900">
                        <div data-lucide="users" class="w-5 h-5"></div>
                        <span class="hidden sm:inline">Clases</span>
                    </button>
                    <button data-view="settings" class="nav-button flex flex-col sm:flex-row items-center justify-center sm:justify-start gap-2 w-full p-3 text-sm font-medium rounded-md transition-colors text-gray-600 hover:bg-gray-200 hover:text-gray-900">
                        <div data-lucide="settings" class="w-5 h-5"></div>
                        <span class="hidden sm:inline">Configuración</span>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Contenido Principal -->
        <main id="main-content" class="flex-1 overflow-y-auto">
            <!-- El contenido se renderizará aquí -->
        </main>
    </div>

    <!-- Modal Genérico -->
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4 hidden no-print">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md max-h-full overflow-y-auto">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 id="modal-title" class="text-xl font-semibold text-gray-800"></h3>
                <button id="modal-close-btn" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="modal-body" class="p-6"></div>
        </div>
    </div>


    <script>
        // --- ESTADO GLOBAL Y LÓGICA DE DATOS ---
        const state = {
            activeView: 'schedule',
            activities: [],
            students: [],
            timeSlots: [],
            schedule: {},
            classEntries: {},
            currentDate: new Date(), // Fecha de referencia para la semana
            selectedActivity: null,
            editingStudentId: null,
            editingTimeSlotId: null,
            editingActivityId: null,
        };

        const pastelColors = ['#FFADAD', '#FFD6A5', '#FDFFB6', '#CAFFBF', '#9BF6FF', '#A0C4FF', '#BDB2FF', '#FFC6FF'];

        function getRandomPastelColor() {
            const usedColors = state.activities.map(a => a.color);
            const availableColors = pastelColors.filter(c => !usedColors.includes(c));
            return availableColors.length > 0 ? availableColors[0] : pastelColors[Math.floor(Math.random() * pastelColors.length)];
        }

        function darkenColor(hex, percent) {
            if (!hex || typeof hex !== 'string') return '#000000';
            let [r, g, b] = hex.match(/\w\w/g).map(x => parseInt(x, 16));
            const amount = Math.floor(255 * (percent / 100));
            r = Math.max(0, r - amount);
            g = Math.max(0, g - amount);
            b = Math.max(0, b - amount);
            return `#${[r,g,b].map(x => x.toString(16).padStart(2, '0')).join('')}`;
        }

        function saveState() {
            const dataToSave = {
                activities: state.activities,
                students: state.students,
                timeSlots: state.timeSlots,
                schedule: state.schedule,
                classEntries: state.classEntries,
            };
            localStorage.setItem('teacherDashboardData', JSON.stringify(dataToSave));
        }

        function loadState() {
            const savedData = localStorage.getItem('teacherDashboardData');
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                state.activities = parsedData.activities || [];
                state.students = parsedData.students || [];
                state.timeSlots = parsedData.timeSlots || [];
                state.schedule = parsedData.schedule || {};
                state.classEntries = parsedData.classEntries || {};
            }
        }
        
        // --- HELPERS DE FECHAS ---
        function getWeekStartDate(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is sunday
            return new Date(d.setDate(diff));
        }

        function formatDate(date, options = { year: 'numeric', month: '2-digit', day: '2-digit' }) {
            return date.toLocaleDateString('sv-SE', options); // sv-SE format is YYYY-MM-DD
        }

        function getWeekDateRange(date) {
            const startOfWeek = getWeekStartDate(date);
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 4);
            const options = { month: 'short', day: 'numeric' };
            return `${startOfWeek.toLocaleDateString('es-ES', options)} - ${endOfWeek.toLocaleDateString('es-ES', {...options, year: 'numeric'})}`;
        }


        // --- LÓGICA DE RENDERIZADO ---
        const mainContent = document.getElementById('main-content');
        const navButtons = document.querySelectorAll('.nav-button');

        function render() {
            mainContent.innerHTML = ''; // Limpiar vista anterior
            let viewContent = '';

            switch (state.activeView) {
                case 'schedule': viewContent = renderScheduleView(); break;
                case 'classes': viewContent = renderClassesView(); break;
                case 'settings': viewContent = renderSettingsView(); break;
                case 'activityDetail': viewContent = renderActivityDetailView(); break;
                default: viewContent = renderScheduleView();
            }
            mainContent.innerHTML = `<div class="animate-fade-in">${viewContent}</div>`;
            lucide.createIcons();
            attachEventListeners();
        }

        function updateNavButtons() {
            navButtons.forEach(btn => {
                const view = btn.dataset.view;
                btn.classList.toggle('bg-blue-600', view === state.activeView);
                btn.classList.toggle('text-white', view === state.activeView);
                btn.classList.toggle('text-gray-600', view !== state.activeView);
                btn.classList.toggle('hover:bg-gray-200', view !== state.activeView);
            });
        }

        // --- VISTAS (Templates HTML) ---

        function renderScheduleView() {
            const days = ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes"];
            const getActivityById = (id) => state.activities.find(c => c.id === id);
            const startOfWeek = getWeekStartDate(state.currentDate);

            const tableRows = state.timeSlots.map(time => {
                const cells = days.map((dayName, dayIndex) => {
                    const cellDate = new Date(startOfWeek);
                    cellDate.setDate(startOfWeek.getDate() + dayIndex);
                    const formattedCellDate = formatDate(cellDate);

                    const activityId = state.schedule[`${dayName}-${time.label}`];
                    const activityInfo = activityId ? getActivityById(activityId) : null;
                    let cellContent = `<div class="p-2 h-full min-h-[40px]"></div>`;
                    if (activityInfo) {
                        const entryId = `${activityInfo.id}_${formattedCellDate}`;
                        const hasPlan = state.classEntries[entryId] && state.classEntries[entryId].planned;
                        const planIndicator = hasPlan ? `<span class="absolute top-1 right-1 text-xs">📝</span>` : '';

                        const style = `background-color: ${activityInfo.color}; color: ${darkenColor(activityInfo.color, 40)}; border: 1px solid ${darkenColor(activityInfo.color, 10)}`;
                        if (activityInfo.type === 'class') {
                            cellContent = `<button data-action="select-activity" data-activity-id='${activityInfo.id}' data-day='${dayName}' data-time='${time.label}' data-date='${formattedCellDate}' class="relative w-full h-full p-2 rounded-md transition-colors text-sm font-semibold" style="${style}">${activityInfo.name}${planIndicator}</button>`;
                        } else {
                            cellContent = `<div class="w-full h-full p-2 rounded-md text-sm font-semibold flex items-center justify-center" style="${style}">${activityInfo.name}</div>`;
                        }
                    }
                    return `<td class="p-1 border">${cellContent}</td>`;
                }).join('');
                return `<tr><td class="p-2 border font-mono bg-gray-50 text-sm">${time.label}</td>${cells}</tr>`;
            }).join('');

            return `
                <div class="p-6 bg-gray-50 min-h-full">
                    <div class="flex justify-between items-center mb-6 no-print">
                         <h2 class="text-2xl font-bold text-gray-800">Horario Semanal</h2>
                         <div class="flex items-center gap-4">
                            <button data-action="prev-week" class="p-2 rounded-md hover:bg-gray-200"><i data-lucide="chevron-left"></i></button>
                            <span class="font-semibold text-lg">${getWeekDateRange(state.currentDate)}</span>
                            <button data-action="next-week" class="p-2 rounded-md hover:bg-gray-200"><i data-lucide="chevron-right"></i></button>
                            <button data-action="today" class="bg-gray-600 text-white px-3 py-2 text-sm rounded-md hover:bg-gray-700">Hoy</button>
                            <button data-action="print-schedule" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center gap-2">
                                <i data-lucide="printer" class="w-5 h-5"></i> Imprimir
                            </button>
                         </div>
                    </div>
                    <div id="printable-schedule">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 hidden print:block text-center">Horario Semanal - ${getWeekDateRange(state.currentDate)}</h2>
                        <div class="bg-white p-4 rounded-lg shadow-md overflow-x-auto">
                            <table class="w-full border-collapse text-center">
                                <thead><tr class="bg-gray-100"><th class="p-2 border w-24">Hora</th>${days.map(day => `<th class="p-2 border">${day}</th>`).join('')}</tr></thead>
                                <tbody>${tableRows.length > 0 ? tableRows : '<tr><td colspan="6" class="p-4 text-gray-500">Añada franjas horarias en Configuración.</td></tr>'}</tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
        }
        
        function renderClassesView() {
            const classes = state.activities.filter(a => a.type === 'class');
            if (classes.length === 0) {
                return `<div class="p-6"><h2 class="text-2xl font-bold text-gray-800 mb-6">Clases y Alumnos</h2><p class="text-gray-500">No hay clases creadas. Ve a Configuración para añadir una.</p></div>`;
            }

            const classesHtml = classes.map(c => {
                const studentsOfClass = state.students.filter(s => c.studentIds?.includes(s.id));
                const studentsHtml = studentsOfClass.map(s => `
                    <div class="flex justify-between items-center p-2 bg-gray-100 rounded-md">
                        <span>${s.name}</span>
                        <button data-action="remove-student-from-class" data-activity-id="${c.id}" data-student-id="${s.id}" class="text-red-500 hover:text-red-700"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </div>
                `).join('');

                return `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold text-gray-800 mb-4" style="color: ${darkenColor(c.color, 40)}">${c.name}</h3>
                    <div class="space-y-2 mb-4">
                        ${studentsHtml || '<p class="text-sm text-gray-500">No hay alumnos en esta clase.</p>'}
                    </div>
                    <div class="flex gap-2 border-t pt-4">
                        <input type="text" id="new-student-name-${c.id}" placeholder="Añadir alumno a esta clase" class="flex-grow p-2 border rounded-md">
                        <button data-action="add-student-to-class" data-activity-id="${c.id}" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    </div>
                </div>
                `;
            }).join('');

            return `
                <div class="p-6 bg-gray-50 min-h-full">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Clases y Alumnos</h2>
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${classesHtml}
                    </div>
                </div>
            `;
        }

        function renderSettingsView() {
             const activitiesHtml = state.activities.map(act => {
                const studentsInClassHtml = act.type === 'class' ? `
                    <div class="mt-3">
                        <h4 class="text-sm font-medium mb-2">Alumnos en esta clase:</h4>
                        <div class="flex flex-wrap gap-2">
                            ${state.students.map(student => `
                                <label class="flex items-center gap-2 text-sm p-2 bg-gray-100 rounded-md">
                                    <input type="checkbox" data-action="toggle-student-in-class" data-activity-id="${act.id}" data-student-id="${student.id}" class="rounded" ${act.studentIds?.includes(student.id) ? 'checked' : ''}>
                                    ${student.name}
                                </label>
                            `).join('')}
                        </div>
                    </div>` : '';

                if (state.editingActivityId === act.id) {
                    return `
                    <div class="p-4 border rounded-md bg-white border-blue-500">
                        <div class="flex justify-between items-center">
                            <input type="color" data-action="change-activity-color" data-id="${act.id}" value="${act.color}" class="p-0 border-none rounded-full cursor-pointer w-7 h-7">
                            <input type="text" data-action="edit-activity-input" value="${act.name}" class="flex-grow p-1 mx-2 border-0 rounded-md focus:ring-0 font-semibold">
                            <div class="flex items-center gap-2">
                                <button data-action="save-activity" data-id="${act.id}" class="text-green-600 hover:text-green-800"><i data-lucide="check" class="w-5 h-5"></i></button>
                                <button data-action="cancel-edit-activity" class="text-red-600 hover:text-red-800"><i data-lucide="x" class="w-5 h-5"></i></button>
                            </div>
                        </div>
                        ${studentsInClassHtml}
                    </div>`;
                }
                return `
                <div class="p-4 border rounded-md">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2 flex-grow">
                           <input type="color" data-action="change-activity-color" data-id="${act.id}" value="${act.color}" class="p-0 border-none rounded-full cursor-pointer w-7 h-7">
                           <span class="font-semibold cursor-pointer" data-action="edit-activity" data-id="${act.id}">${act.name} <span class="text-xs text-gray-500 font-normal">(${act.type === 'class' ? 'Clase' : 'General'})</span></span>
                        </div>
                        <button data-action="delete-activity" data-id="${act.id}" class="text-red-500 hover:text-red-700 ml-2"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                    </div>
                    ${studentsInClassHtml}
                </div>`;
            }).join('');

            const timeSlotsHtml = state.timeSlots.map((slot, index) => {
                if (state.editingTimeSlotId === slot.id) {
                    return `
                    <div class="flex justify-between items-center bg-white p-2 rounded-md border border-blue-500">
                        <input type="text" data-action="edit-timeslot-input" value="${slot.label}" class="flex-grow p-1 border-0 rounded-md focus:ring-0">
                        <div class="flex items-center gap-2">
                            <button data-action="save-timeslot" data-id="${slot.id}" class="text-green-600 hover:text-green-800"><i data-lucide="check" class="w-5 h-5"></i></button>
                            <button data-action="cancel-edit-timeslot" class="text-red-600 hover:text-red-800"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                    </div>`;
                }
                return `
                    <div class="flex justify-between items-center bg-gray-100 p-2 rounded-md">
                        <span class="flex-grow cursor-pointer" data-action="edit-timeslot" data-id="${slot.id}">${slot.label}</span>
                        <div class="flex items-center gap-2">
                            <button data-action="reorder-timeslot" data-index="${index}" data-direction="up" ${index === 0 ? 'disabled' : ''} class="disabled:opacity-25 disabled:cursor-not-allowed text-gray-600 hover:text-gray-900"><i data-lucide="chevron-up" class="w-5 h-5"></i></button>
                            <button data-action="reorder-timeslot" data-index="${index}" data-direction="down" ${index === state.timeSlots.length - 1 ? 'disabled' : ''} class="disabled:opacity-25 disabled:cursor-not-allowed text-gray-600 hover:text-gray-900"><i data-lucide="chevron-down" class="w-5 h-5"></i></button>
                            <button data-action="delete-timeslot" data-id="${slot.id}" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>`;
            }).join('');
            
            const scheduleTableRows = state.timeSlots.map(time => {
                const cells = ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes"].map(day => `
                    <td class="p-1 border">
                        <select data-action="schedule-change" data-day="${day}" data-time="${time.label}" class="w-full p-1 border-0 rounded-md focus:ring-1 focus:ring-blue-500 text-xs">
                            <option value="">Libre</option>
                            ${state.activities.map(act => `<option value="${act.id}" ${state.schedule[`${day}-${time.label}`] === act.id ? 'selected' : ''}>${act.name}</option>`).join('')}
                        </select>
                    </td>
                `).join('');
                return `<tr><td class="p-2 border font-mono bg-gray-50">${time.label}</td>${cells}</tr>`;
            }).join('');


            return `
                <div class="p-6 bg-gray-50 min-h-full space-y-8">
                    <h2 class="text-2xl font-bold text-gray-800">Configuración General</h2>
                    <div class="grid lg:grid-cols-2 gap-8 items-start">
                        <div class="space-y-8">
                            <!-- Gestión de Actividades -->
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h3 class="text-lg font-semibold mb-3">Gestión de Actividades</h3>
                                <div class="flex gap-2 mb-2">
                                    <input type="text" id="new-activity-name" placeholder="Nombre de la actividad" class="flex-grow p-2 border rounded-md"/>
                                    <button data-action="add-activity" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center gap-2"><i data-lucide="plus-circle" class="w-5 h-5"></i>Añadir</button>
                                </div>
                                <div class="flex gap-4 mb-4 text-sm">
                                    <label class="flex items-center gap-2"><input type="radio" name="activityType" value="class" checked class="form-radio"/>Clase con alumnos</label>
                                    <label class="flex items-center gap-2"><input type="radio" name="activityType" value="general" class="form-radio"/>Actividad general</label>
                                </div>
                                <div class="space-y-3 max-h-96 overflow-y-auto pr-2">${activitiesHtml}</div>
                            </div>
                             <!-- Importación Rápida -->
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h3 class="text-lg font-semibold mb-3 flex items-center gap-2"><i data-lucide="clipboard-paste" class="w-5 h-5"></i> Importación Rápida de Alumnos</h3>
                                <div class="space-y-4">
                                    <div><label class="block text-sm font-medium text-gray-700 mb-1">1. Selecciona la clase de destino</label><select id="import-target-class" class="w-full p-2 border rounded-md"><option value="">-- Elige una clase --</option>${state.activities.filter(a => a.type === 'class').map(c => `<option value="${c.id}">${c.name}</option>`).join('')}</select></div>
                                    <div><label class="block text-sm font-medium text-gray-700 mb-1">2. Pega la lista de alumnos</label><textarea id="student-list-text" placeholder="Juan Pérez\\nMaría García\\n..." class="w-full p-2 border rounded-md h-32"></textarea></div>
                                    <button data-action="import-students" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 flex items-center justify-center gap-2"><i data-lucide="upload" class="w-5 h-5"></i> Importar Alumnos</button>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-8">
                            <!-- Generador Automático de Horario -->
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h3 class="text-lg font-semibold mb-3 flex items-center gap-2"><i data-lucide="wand-2" class="w-5 h-5"></i> Generador Automático de Horario</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="block text-sm font-medium">Hora inicio</label><input type="time" id="gen-start-time" value="08:00" class="w-full p-2 border rounded-md"></div>
                                    <div><label class="block text-sm font-medium">Hora fin</label><input type="time" id="gen-end-time" value="17:00" class="w-full p-2 border rounded-md"></div>
                                    <div><label class="block text-sm font-medium">Duración clase (min)</label><input type="number" id="gen-class-duration" value="55" class="w-full p-2 border rounded-md"></div>
                                    <div><label class="block text-sm font-medium">Duración descanso (min)</label><input type="number" id="gen-break-duration" value="30" class="w-full p-2 border rounded-md"></div>
                                    <div class="col-span-2"><label class="block text-sm font-medium">Hora inicio descanso (opcional)</label><input type="time" id="gen-break-start" value="11:00" class="w-full p-2 border rounded-md"></div>
                                </div>
                                <button data-action="generate-schedule-slots" class="mt-4 w-full bg-teal-600 text-white px-4 py-2 rounded-md hover:bg-teal-700 flex items-center justify-center gap-2">Generar Franjas</button>
                            </div>
                            <!-- Gestión de Franjas Horarias -->
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h3 class="text-lg font-semibold mb-3 flex items-center gap-2"><i data-lucide="clock" class="w-5 h-5"></i> Franjas Horarias</h3>
                                <div class="flex gap-2 mb-4">
                                    <input type="text" id="new-timeslot-label" placeholder="Ej: 08:00-09:00" class="flex-grow p-2 border rounded-md"/>
                                    <button data-action="add-timeslot" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center gap-2"><i data-lucide="plus-circle" class="w-5 h-5"></i>Añadir</button>
                                </div>
                                <div class="space-y-2">${timeSlotsHtml}</div>
                            </div>
                            <!-- Horario Semanal -->
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h3 class="text-lg font-semibold mb-3">Configurar Horario Semanal</h3>
                                <div class="overflow-x-auto">
                                    <table class="w-full border-collapse text-sm">
                                        <thead><tr class="bg-gray-100"><th class="p-2 border">Hora</th>${["Lunes", "Martes", "Miércoles", "Jueves", "Viernes"].map(day => `<th class="p-2 border">${day}</th>`).join('')}</tr></thead>
                                        <tbody>${scheduleTableRows}</tbody>
                                    </table>
                                </div>
                                <button data-action="save-schedule" class="mt-4 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 w-full flex items-center justify-center gap-2"><i data-lucide="save" class="w-5 h-5"></i> Guardar Horario</button>
                            </div>
                             <!-- Copia de Seguridad y Zona de Peligro -->
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h3 class="text-lg font-semibold mb-3">Copia de Seguridad</h3>
                                <div class="flex gap-4">
                                    <button data-action="export-data" class="bg-gray-700 text-white px-4 py-2 rounded-md hover:bg-gray-800 flex items-center gap-2"><i data-lucide="download" class="w-5 h-5"></i> Exportar</button>
                                    <label class="bg-gray-700 text-white px-4 py-2 rounded-md hover:bg-gray-800 flex items-center gap-2 cursor-pointer"><i data-lucide="upload" class="w-5 h-5"></i> Importar<input type="file" id="import-file-input" accept=".json" class="hidden"/></label>
                                </div>
                            </div>
                            <div class="bg-red-50 border-l-4 border-red-400 p-4 rounded-r-lg">
                                <h3 class="text-lg font-semibold text-red-800 flex items-center gap-2"><i data-lucide="alert-triangle" class="w-5 h-5"></i> Zona de Peligro</h3>
                                <button data-action="delete-all-data" class="mt-4 w-full bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 flex items-center justify-center gap-2"><i data-lucide="trash-2" class="w-5 h-5"></i> Borrar todos los datos</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderActivityDetailView() {
            const { name, day, time, date } = state.selectedActivity;
            const entryId = `${state.selectedActivity.id}_${date}`;
            const entry = state.classEntries[entryId] || { planned: '', completed: '', annotations: {} };
            const studentsInClass = state.students.filter(s => state.selectedActivity.studentIds?.includes(s.id));

            const annotationsHtml = studentsInClass.length > 0 ? studentsInClass.map(student => `
                <div key="${student.id}">
                    <label class="block font-medium text-gray-700">${student.name}</label>
                    <textarea data-action="annotation-change" data-student-id="${student.id}" placeholder="Comportamiento, dudas, trabajo..." class="w-full p-2 border rounded-md mt-1 h-24">${entry.annotations?.[student.id] || ''}</textarea>
                </div>
            `).join('') : '<p class="text-gray-500">No hay alumnos asignados a esta clase.</p>';

            return `
                <div class="p-6 bg-gray-50 min-h-full">
                    <div class="flex justify-between items-center mb-6 no-print">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">${name}</h2>
                            <p class="text-gray-500">${day}, ${new Date(date + 'T00:00:00').toLocaleDateString('es-ES', {day: 'numeric', month: 'long', year: 'numeric'})} (${time})</p>
                        </div>
                        <button data-action="back-to-schedule" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Volver al horario</button>
                    </div>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
                            <div><label class="block text-lg font-semibold mb-2 text-gray-700">Planificación para hoy</label><textarea data-action="planned-change" placeholder="Ejercicios, teoría, actividades..." class="w-full p-2 border rounded-md h-32">${entry.planned || ''}</textarea></div>
                            <div><label class="block text-lg font-semibold mb-2 text-gray-700">Resumen de lo hecho</label><textarea data-action="completed-change" placeholder="¿Qué se ha hecho finalmente?" class="w-full p-2 border rounded-md h-32">${entry.completed || ''}</textarea></div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-3">Anotaciones de Alumnos</h3>
                            <div class="space-y-4 max-h-96 overflow-y-auto pr-2">${annotationsHtml}</div>
                        </div>
                    </div>
                    <div class="mt-6 no-print"><button data-action="save-class-entry" class="w-full bg-green-600 text-white px-4 py-3 rounded-md hover:bg-green-700 flex items-center justify-center gap-2 text-lg"><i data-lucide="save" class="w-5 h-5"></i> Guardar Cambios de la Sesión</button></div>
                </div>
            `;
        }

        // --- MANEJADORES DE EVENTOS Y ACCIONES ---

        function attachEventListeners() {
            const elements = document.querySelectorAll('[data-action]');
            elements.forEach(el => {
                const action = el.dataset.action;
                const eventType = ['INPUT', 'TEXTAREA', 'SELECT'].includes(el.tagName) ? 'input' : 'click';
                el.addEventListener(eventType, (e) => handleAction(action, el, e));
            });
            
            const importInput = document.getElementById('import-file-input');
            if (importInput) {
                importInput.addEventListener('change', handleAction.bind(null, 'import-data', importInput));
            }
        }
        
        function handleAction(action, element, event) {
            const id = element.dataset.id;
            switch(action) {
                // Actions that re-render the view
                case 'add-activity':
                case 'delete-activity':
                case 'add-student-to-class':
                case 'remove-student-from-class':
                case 'add-timeslot':
                case 'delete-timeslot':
                case 'reorder-timeslot':
                case 'import-students':
                case 'select-activity':
                case 'back-to-schedule':
                case 'generate-schedule-slots':
                case 'edit-timeslot':
                case 'save-timeslot':
                case 'cancel-edit-timeslot':
                case 'edit-activity':
                case 'save-activity':
                case 'cancel-edit-activity':
                case 'prev-week':
                case 'next-week':
                case 'today':
                    if (actionHandlers[action]) actionHandlers[action](id, element);
                    render();
                    break;
                // Actions that don't need a full re-render
                case 'save-schedule':
                case 'export-data':
                case 'delete-all-data':
                case 'import-data':
                case 'save-class-entry':
                case 'print-schedule':
                    if (actionHandlers[action]) actionHandlers[action](id, element, event);
                    break;
                // Live input changes
                case 'planned-change':
                case 'completed-change':
                case 'annotation-change':
                case 'change-activity-color':
                    if (actionHandlers[action]) actionHandlers[action](id, element);
                    break;
                 // Live input changes for student edit view
                case 'edit-student-name-input':
                case 'edit-student-notes-input':
                case 'edit-timeslot-input':
                case 'edit-activity-input':
                    // These are handled by the save button, no action needed on input
                    break;
                // Schedule select change
                case 'schedule-change':
                    const { day, time } = element.dataset;
                    state.schedule[`${day}-${time}`] = element.value;
                    // No save/render, user must click save button
                    break;
            }
        }
        
        const actionHandlers = {
            // --- Student Actions ---
            'add-student-to-class': (id, element) => {
                const activityId = element.dataset.activityId;
                const nameInput = document.getElementById(`new-student-name-${activityId}`);
                const name = nameInput.value.trim();
                if (!name) return;

                const activity = state.activities.find(a => a.id === activityId);
                if (!activity) return;

                // Check if student already exists (case-insensitive)
                let student = state.students.find(s => s.name.toLowerCase() === name.toLowerCase());

                if (!student) {
                    // If not, create a new one
                    student = { id: crypto.randomUUID(), name: name, generalNotes: '' };
                    state.students.push(student);
                }
                
                // Add student to class if not already in it
                if (!activity.studentIds?.includes(student.id)) {
                    activity.studentIds = [...(activity.studentIds || []), student.id];
                }
                
                nameInput.value = '';
                saveState();
            },
            'remove-student-from-class': (id, element) => {
                const { activityId, studentId } = element.dataset;
                const activity = state.activities.find(a => a.id === activityId);
                if (activity) {
                    activity.studentIds = activity.studentIds?.filter(sid => sid !== studentId);
                    saveState();
                }
            },
            // --- Activity Actions ---
            'add-activity': () => {
                const nameInput = document.getElementById('new-activity-name');
                const name = nameInput.value.trim();
                const type = document.querySelector('input[name="activityType"]:checked').value;
                if (name) {
                    state.activities.push({ 
                        id: crypto.randomUUID(), 
                        name, 
                        type, 
                        studentIds: [],
                        color: getRandomPastelColor()
                    });
                    nameInput.value = '';
                    saveState();
                }
            },
            'delete-activity': (id) => {
                showModal('Confirmar Eliminación', '¿Seguro que quieres eliminar esta actividad?', () => {
                    state.activities = state.activities.filter(a => a.id !== id);
                    saveState();
                    render();
                });
            },
            'edit-activity': (id) => {
                state.editingActivityId = id;
            },
            'cancel-edit-activity': () => {
                state.editingActivityId = null;
            },
            'save-activity': (id) => {
                const activity = state.activities.find(a => a.id === id);
                if (activity) {
                    const input = document.querySelector(`input[data-action="edit-activity-input"]`);
                    const newName = input.value.trim();
                    if (newName) {
                        activity.name = newName;
                        saveState();
                    }
                }
                state.editingActivityId = null;
            },
            'change-activity-color': (id, element) => {
                 const activity = state.activities.find(a => a.id === id);
                 if(activity) {
                    activity.color = element.value;
                    saveState();
                    // Live update color in schedule view if it's the current view
                    if(state.activeView === 'schedule' || state.activeView === 'classes') {
                        render();
                    }
                 }
            },
            'toggle-student-in-class': (id, element) => {
                const { activityId, studentId } = element.dataset;
                const activity = state.activities.find(a => a.id === activityId);
                if (activity) {
                    const studentIds = activity.studentIds || [];
                    const newStudentIds = studentIds.includes(studentId) ? studentIds.filter(sid => sid !== studentId) : [...studentIds, studentId];
                    activity.studentIds = newStudentIds;
                    saveState();
                }
            },
            // --- TimeSlot Actions ---
            'add-timeslot': () => {
                const labelInput = document.getElementById('new-timeslot-label');
                const label = labelInput.value.trim();
                if (label) {
                    const newOrder = state.timeSlots.length > 0 ? Math.max(...state.timeSlots.map(t => t.order)) + 1 : 0;
                    state.timeSlots.push({ id: crypto.randomUUID(), label, order: newOrder });
                    labelInput.value = '';
                    saveState();
                }
            },
            'delete-timeslot': (id) => {
                state.timeSlots = state.timeSlots.filter(t => t.id !== id);
                saveState();
            },
            'edit-timeslot': (id) => {
                state.editingTimeSlotId = id;
            },
            'cancel-edit-timeslot': () => {
                state.editingTimeSlotId = null;
            },
            'save-timeslot': (id) => {
                const timeSlot = state.timeSlots.find(t => t.id === id);
                if (timeSlot) {
                    const input = document.querySelector(`input[data-action="edit-timeslot-input"]`);
                    const oldLabel = timeSlot.label;
                    const newLabel = input.value.trim();
                    
                    if (newLabel && oldLabel !== newLabel) {
                        timeSlot.label = newLabel;

                        // Update schedule keys that used the old label
                        Object.keys(state.schedule).forEach(key => {
                            if (key.endsWith(`-${oldLabel}`)) {
                                const day = key.split('-')[0];
                                const newKey = `${day}-${newLabel}`;
                                state.schedule[newKey] = state.schedule[key];
                                delete state.schedule[key];
                            }
                        });
                        saveState();
                    }
                }
                state.editingTimeSlotId = null;
            },
            'reorder-timeslot': (id, element) => {
                const index = parseInt(element.dataset.index, 10);
                const direction = element.dataset.direction;
                const otherIndex = direction === 'up' ? index - 1 : index + 1;
                
                const currentSlot = state.timeSlots[index];
                const otherSlot = state.timeSlots[otherIndex];

                [currentSlot.order, otherSlot.order] = [otherSlot.order, currentSlot.order];
                
                state.timeSlots.sort((a, b) => a.order - b.order);
                saveState();
            },
            'generate-schedule-slots': () => {
                const startTimeStr = document.getElementById('gen-start-time').value;
                const endTimeStr = document.getElementById('gen-end-time').value;
                const classDuration = parseInt(document.getElementById('gen-class-duration').value, 10);
                const breakDuration = parseInt(document.getElementById('gen-break-duration').value, 10);
                const breakStartTimeStr = document.getElementById('gen-break-start').value;

                if (!startTimeStr || !endTimeStr || isNaN(classDuration)) {
                    alert('Por favor, rellena la hora de inicio, fin y la duración de la clase.');
                    return;
                }

                const timeToMinutes = (timeStr) => {
                    const [h, m] = timeStr.split(':').map(Number);
                    return h * 60 + m;
                };
                const minutesToTime = (totalMinutes) => {
                    const h = Math.floor(totalMinutes / 60).toString().padStart(2, '0');
                    const m = (totalMinutes % 60).toString().padStart(2, '0');
                    return `${h}:${m}`;
                };

                const startMinutes = timeToMinutes(startTimeStr);
                const endMinutes = timeToMinutes(endTimeStr);
                const breakStartMinutes = breakStartTimeStr ? timeToMinutes(breakStartTimeStr) : -1;

                const newTimeSlots = [];
                let currentTime = startMinutes;
                let order = 0;
                let breakAdded = false;

                while (currentTime < endMinutes) {
                    // Add break if it's time and it hasn't been added yet
                    if (breakDuration > 0 && breakStartMinutes !== -1 && currentTime >= breakStartMinutes && !breakAdded) {
                        const breakEndTime = currentTime + breakDuration;
                        if (breakEndTime > endMinutes) break;
                        newTimeSlots.push({
                            id: crypto.randomUUID(),
                            label: `${minutesToTime(currentTime)}-${minutesToTime(breakEndTime)}`,
                            order: order++
                        });
                        currentTime = breakEndTime;
                        breakAdded = true;
                        continue;
                    }

                    // Add class slot
                    const classEndTime = currentTime + classDuration;
                    if (classEndTime > endMinutes) break;
                     newTimeSlots.push({
                        id: crypto.randomUUID(),
                        label: `${minutesToTime(currentTime)}-${minutesToTime(classEndTime)}`,
                        order: order++
                    });
                    currentTime = classEndTime;
                }
                
                state.timeSlots = newTimeSlots;
                saveState();
            },
            // --- Schedule Actions ---
            'save-schedule': () => {
                saveState();
                alert('Horario guardado con éxito.');
            },
            'print-schedule': () => {
                window.print();
            },
            'select-activity': (id, element) => {
                const { activityId, day, time, date } = element.dataset;
                const activityInfo = state.activities.find(a => a.id === activityId);
                state.selectedActivity = { ...activityInfo, day, time, date };
                state.activeView = 'activityDetail';
            },
            'back-to-schedule': () => {
                state.selectedActivity = null;
                state.activeView = 'schedule';
            },
            'prev-week': () => {
                state.currentDate.setDate(state.currentDate.getDate() - 7);
            },
            'next-week': () => {
                state.currentDate.setDate(state.currentDate.getDate() + 7);
            },
            'today': () => {
                state.currentDate = new Date();
            },
            // --- Class Entry Actions ---
            'planned-change': (id, element) => {
                const entryId = `${state.selectedActivity.id}_${state.selectedActivity.date}`;
                if (!state.classEntries[entryId]) state.classEntries[entryId] = { annotations: {} };
                state.classEntries[entryId].planned = element.value;
            },
            'completed-change': (id, element) => {
                const entryId = `${state.selectedActivity.id}_${state.selectedActivity.date}`;
                if (!state.classEntries[entryId]) state.classEntries[entryId] = { annotations: {} };
                state.classEntries[entryId].completed = element.value;
            },
            'annotation-change': (id, element) => {
                const { studentId } = element.dataset;
                const entryId = `${state.selectedActivity.id}_${state.selectedActivity.date}`;
                if (!state.classEntries[entryId]) state.classEntries[entryId] = { annotations: {} };
                state.classEntries[entryId].annotations[studentId] = element.value;
            },
            'save-class-entry': () => {
                saveState();
                alert('Datos de la sesión guardados.');
                actionHandlers['back-to-schedule']();
                render();
            },
            // --- Data Management Actions ---
            'import-students': () => {
                const targetClassId = document.getElementById('import-target-class').value;
                const studentListText = document.getElementById('student-list-text').value;
                const activity = state.activities.find(a => a.id === targetClassId);
                if (!activity || studentListText.trim() === '') return alert("Selecciona una clase y pega una lista de alumnos.");

                const names = studentListText.trim().split('\n').filter(name => name.trim() !== '');
                
                names.forEach(name => {
                    const trimmedName = name.trim();
                    if(!trimmedName) return;

                    let student = state.students.find(s => s.name.toLowerCase() === trimmedName.toLowerCase());
                    if (!student) {
                        student = { id: crypto.randomUUID(), name: trimmedName, generalNotes: '' };
                        state.students.push(student);
                    }
                    if (!activity.studentIds?.includes(student.id)) {
                        activity.studentIds = [...(activity.studentIds || []), student.id];
                    }
                });
                
                saveState();
            },
            'export-data': () => {
                const dataStr = JSON.stringify({
                    activities: state.activities,
                    students: state.students,
                    timeSlots: state.timeSlots,
                    schedule: state.schedule,
                    classEntries: state.classEntries,
                }, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cuaderno-profesor-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            },
            'import-data': (id, element, event) => {
                const file = event.target.files[0];
                if (!file) return;
                showModal('Confirmar Importación', 'Importar un archivo reemplazará todos los datos actuales. ¿Estás seguro?', () => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            state.activities = data.activities || [];
                            state.students = data.students || [];
                            state.timeSlots = data.timeSlots || [];
                            state.schedule = data.schedule || {};
                            state.classEntries = data.classEntries || {};
                            saveState();
                            alert('Datos importados con éxito.');
                            window.location.reload();
                        } catch (error) {
                            alert('Error al importar el archivo.');
                        }
                    };
                    reader.readAsText(file);
                });
            },
            'delete-all-data': () => {
                showModal('Borrar Todos los Datos', 'Esta acción es irreversible y borrará todos los datos de la aplicación. ¿Estás seguro?', () => {
                    localStorage.removeItem('teacherDashboardData');
                    alert('Todos los datos han sido borrados.');
                    window.location.reload();
                });
            },
        };

        // --- MODAL HELPER ---
        const modalContainer = document.getElementById('modal-container');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        function showModal(title, content, onConfirm) {
            modalTitle.textContent = title;
            modalBody.innerHTML = `<p>${content}</p>
                <div class="flex justify-end gap-4 mt-6">
                    <button id="modal-cancel" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancelar</button>
                    <button id="modal-confirm" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Confirmar</button>
                </div>`;
            
            const close = () => modalContainer.classList.add('hidden');
            modalContainer.classList.remove('hidden');
            
            document.getElementById('modal-confirm').onclick = () => {
                if(onConfirm) onConfirm();
                close();
            };
            document.getElementById('modal-cancel').onclick = close;
            modalCloseBtn.onclick = close;
        }

        // --- INICIALIZACIÓN ---
        function init() {
            loadState();
            updateNavButtons();
            render();
            
            navButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    state.activeView = btn.dataset.view;
                    state.selectedActivity = null;
                    state.editingStudentId = null;
                    updateNavButtons();
                    render();
                });
            });
        }

        init();
    </script>
</body>
</html>
